<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SA Community Map | Testing Mode</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: #111; overflow: hidden; color: white; }
        
        /* Map Container - Gray background shows it's active even if tiles are slow */
        #map-view {
            position: absolute; top: 0; left: 0; width: 100%;
            height: calc(100% - 70px); z-index: 1; background: #222; 
        }

        #content-view {
            position: absolute; top: 0; left: 0; width: 100%;
            height: calc(100% - 70px); background: #000;
            z-index: 2000; display: none; overflow-y: auto; padding: 20px;
        }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: #000; border-top: 2px solid #333;
            display: flex; justify-content: space-around;
            align-items: center; z-index: 4000;
        }

        .nav-link-custom {
            color: #999; text-decoration: none; font-size: 11px;
            display: flex; flex-direction: column; align-items: center;
            border: none; background: none; cursor: pointer;
        }

        .nav-link-custom.active { color: #00d2ff; font-weight: bold; }
        .nav-link-custom i { font-size: 24px; margin-bottom: 2px; }

        .card { background: #1a1a1a !important; border: 1px solid #333 !important; color: white !important; margin-bottom: 15px; }
        
        #upload-btn {
            position: fixed; bottom: 90px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            z-index: 3000; font-size: 24px; box-shadow: 0 0 15px rgba(0,210,255,0.5);
        }
    </style>
</head>
<body>

    <button id="upload-btn" class="btn btn-info text-dark shadow" onclick="openContributionMenu()">
        <i class="fas fa-camera"></i>
    </button>

    <div id="map-view">
        <div id="cesiumContainer" style="width: 100%; height: 100%;"></div>
    </div>

    <div id="content-view">
        <h2 id="view-title" class="text-info border-bottom pb-2 mb-4">Feed</h2>
        <div id="view-body" class="row"></div>
    </div>

    <nav class="bottom-nav">
        <button id="nav-home" class="nav-link-custom active" onclick="navigate('home')">
            <i class="fas fa-globe-africa"></i><span>Home</span>
        </button>
        <button id="nav-posts" class="nav-link-custom" onclick="navigate('posts')">
            <i class="fas fa-list"></i><span>Posts</span>
        </button>
        <button id="nav-events" class="nav-link-custom" onclick="navigate('events')">
            <i class="fas fa-calendar"></i><span>Events</span>
        </button>
        <button id="nav-updates" class="nav-link-custom" onclick="navigate('updates')">
            <i class="fas fa-bell"></i><span>Update</span>
        </button>
        <button id="nav-profile" class="nav-link-custom" onclick="navigate('profile')">
            <i class="fas fa-user"></i><span>Profile</span>
        </button>
    </nav>

    <script>
        const API_BASE = "http://your-flask-api-server:5000/api";
        let appData = [];

        // --- 1. INITIALIZE CESIUM (UNLOCKED) ---
        const viewer = new Cesium.Viewer('cesiumContainer', {
            // Using Ion default imagery (requires no token for basic testing)
            imageryProvider: Cesium.createWorldImagery(),
            baseLayerPicker: true, // Allow you to change map type if one doesn't load
            geocoder: true,        // Allow you to search for "Botshabelo" manually
            homeButton: true,
            sceneModePicker: true,
            navigationHelpButton: false,
            animation: false,
            timeline: false
        });

        // Start view looking at South Africa
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(24.0, -29.0, 5000000.0), // High altitude over SA
            orientation: { pitch: Cesium.Math.toRadians(-90.0) } // Look straight down
        });

        // --- 2. FULL LOAD PINS FUNCTION ---
        async function loadPins() {
            try {
                const res = await fetch(`${API_BASE}/posts`);
                appData = await res.json();
                viewer.entities.removeAll();

                appData.forEach(item => {
                    const pos = Cesium.Cartesian3.fromDegrees(item.lon, item.lat);
                    viewer.entities.add({
                        id: `pin-${item._id}`,
                        position: pos,
                        billboard: {
                            image: 'https://img.icons8.com/color/48/marker.png',
                            width: 32, height: 32, verticalOrigin: Cesium.VerticalOrigin.BOTTOM
                        },
                        description: `<div style="color:black;"><h3>${item.title}</h3><p>${item.content}</p></div>`
                    });

                    if (item.type === 'alert' && item.radius) {
                        viewer.entities.add({
                            position: pos,
                            ellipse: {
                                semiMinorAxis: parseFloat(item.radius),
                                semiMajorAxis: parseFloat(item.radius),
                                material: Cesium.Color.RED.withAlpha(0.3)
                            }
                        });
                    }
                });
            } catch (err) { console.log("API not reached, testing with empty data."); }
        }

        // --- 3. FULL NAVIGATE FUNCTION ---
        function navigate(tab) {
            const mapView = document.getElementById('map-view');
            const contentView = document.getElementById('content-view');
            const viewTitle = document.getElementById('view-title');
            const viewBody = document.getElementById('view-body');

            document.querySelectorAll('.nav-link-custom').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');

            if (tab === 'home') {
                mapView.style.display = 'block';
                contentView.style.display = 'none';
                return;
            }

            mapView.style.display = 'none';
            contentView.style.display = 'block';
            viewTitle.innerText = tab.toUpperCase();
            viewBody.innerHTML = '';

            const filtered = appData.filter(i => {
                if (tab === 'posts') return i.type === 'post' || i.type === 'street_view';
                if (tab === 'events') return i.type === 'event';
                if (tab === 'updates') return i.type === 'alert';
                return false;
            });

            if (tab === 'profile') {
                viewBody.innerHTML = `<div class="col-12"><div class="card p-3"><h4>User Profile</h4><p>Testing Mode Active</p></div></div>`;
                return;
            }

            if (filtered.length === 0) {
                viewBody.innerHTML = `<div class="col-12 text-muted">No entries found for ${tab}.</div>`;
            } else {
                filtered.forEach(i => {
                    const col = document.createElement('div');
                    col.className = 'col-12 col-md-6';
                    col.innerHTML = `<div class="card p-3"><h5>${i.title}</h5><p>${i.content}</p></div>`;
                    viewBody.appendChild(col);
                });
            }
        }

        // --- 4. CONTRIBUTION ---
        function openContributionMenu() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.onchange = async (e) => {
                alert("Upload process started. Files would go to cdn.oxeansa.co.za");
            };
            input.click();
        }

        loadPins();
    </script>
</body>
</html>
