<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasi Power</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: #000; overflow: hidden;
        }

        /* Full Screen Map Container */
        #map-view {
            position: absolute; top: 0; left: 0; width: 100%;
            height: calc(100% - 70px); z-index: 1;
        }

        /* Dynamic Content Overlay */
        #content-view {
            position: absolute; top: 0; left: 0; width: 100%;
            height: calc(100% - 70px); background: #000;
            z-index: 2000; display: none; overflow-y: auto;
        }

        /* Floating Contribution Button */
        #upload-btn {
            position: fixed; bottom: 90px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            z-index: 3000; display: flex; align-items: center;
            justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: #111; border-top: 1px solid #333;
            display: flex; justify-content: space-around;
            align-items: center; z-index: 4000;
        }

        .nav-link-custom {
            color: #777; text-decoration: none; font-size: 10px;
            display: flex; flex-direction: column; align-items: center;
            border: none; background: none; transition: 0.2s;
        }

        .nav-link-custom.active { color: #0d6efd; }
        .nav-link-custom i { font-size: 22px; margin-bottom: 2px; }

        /* Safety Alert Toast */
        #safety-toast {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%); z-index: 5000;
            min-width: 280px; display: none;
        }

        .cesium-infoBox { background: white !important; border-radius: 8px !important; }
    </style>
</head>
<body class="text-light">

    <div id="safety-toast" class="alert alert-danger shadow-lg text-center fw-bold border-2" role="alert">
        <i class="fas fa-triangle-exclamation me-2"></i> 9781 HAZARD NEARBY
    </div>

    <button id="upload-btn" class="btn btn-primary" onclick="openContributionMenu()">
        <i class="fas fa-video"></i>
    </button>

    <div id="map-view">
        <div id="cesiumContainer" style="width: 100%; height: 100%;"></div>
    </div>

    <div id="content-view" class="p-3">
        <div class="container-fluid">
            <h2 id="view-title" class="mb-4 text-primary fw-bold border-bottom pb-2">Home</h2>
            <div id="view-body" class="row g-3">
                </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button id="nav-home" class="nav-link-custom active" onclick="navigate('home')">
            <i class="fas fa-mountain-city"></i><span>3D Map</span>
        </button>
        <button id="nav-posts" class="nav-link-custom" onclick="navigate('posts')">
            <i class="fas fa-layer-group"></i><span>Feed</span>
        </button>
        <button id="nav-events" class="nav-link-custom" onclick="navigate('events')">
            <i class="fas fa-calendar-star"></i><span>Events</span>
        </button>
        <button id="nav-updates" class="nav-link-custom" onclick="navigate('updates')">
            <i class="fas fa-bullhorn"></i><span>Alerts</span>
        </button>
        <button id="nav-profile" class="nav-link-custom" onclick="navigate('profile')">
            <i class="fas fa-user-circle"></i><span>Profile</span>
        </button>
    </nav>

    <script>
        const API_BASE = "http://your-flask-api-server:5000/api";
        const BOTSHABELO = { lon: 26.7111, lat: -29.2333 };
        let appData = [];

        // --- 1. INITIALIZE CESIUM ---
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            animation: false, timeline: false, baseLayerPicker: false,
            geocoder: false, infoBox: true
        });

        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(BOTSHABELO.lon, BOTSHABELO.lat, 2000),
            orientation: { pitch: Cesium.Math.toRadians(-35.0) }
        });

        // --- 2. DYNAMIC PINS & DATA LOADING ---
        async function loadPins() {
            try {
                const res = await fetch(`${API_BASE}/posts`);
                appData = await res.json();

                viewer.entities.removeAll();

                appData.forEach(item => {
                    const pos = Cesium.Cartesian3.fromDegrees(item.lon, item.lat);
                    
                    // Pin Marker
                    viewer.entities.add({
                        id: `pin-${item._id}`,
                        position: pos,
                        billboard: {
                            image: item.type === 'alert' ? 'https://img.icons8.com/color/48/marker-storm.png' : 'https://img.icons8.com/color/48/marker.png',
                            width: 32, height: 32, verticalOrigin: Cesium.VerticalOrigin.BOTTOM
                        },
                        description: `
                            <div class="p-2 text-dark">
                                <h5 class="fw-bold">${item.title}</h5>
                                <p>${item.content}</p>
                                ${item.media_url ? `<video width="100%" class="rounded" controls autoplay loop muted><source src="${item.media_url}" type="video/mp4"></video>` : ''}
                            </div>`
                    });

                    // Alert Radius
                    if (item.type === 'alert' && item.radius) {
                        viewer.entities.add({
                            position: pos,
                            ellipse: {
                                semiMinorAxis: parseFloat(item.radius),
                                semiMajorAxis: parseFloat(item.radius),
                                material: Cesium.Color.RED.withAlpha(0.2),
                                outline: true, outlineColor: Cesium.Color.RED
                            }
                        });
                    }
                });
            } catch (err) { console.error("Data fetch error", err); }
        }

        // --- 3. DYNAMIC NAVIGATION (FULLY EXPANDED) ---
        function navigate(tab) {
            const mapView = document.getElementById('map-view');
            const contentView = document.getElementById('content-view');
            const viewTitle = document.getElementById('view-title');
            const viewBody = document.getElementById('view-body');
            const uploadBtn = document.getElementById('upload-btn');

            document.querySelectorAll('.nav-link-custom').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');

            if (tab === 'home') {
                mapView.style.display = 'block';
                contentView.style.display = 'none';
                uploadBtn.style.display = 'flex';
                return;
            }

            mapView.style.display = 'none';
            contentView.style.display = 'block';
            uploadBtn.style.display = 'none';
            viewTitle.innerText = tab.charAt(0).toUpperCase() + tab.slice(1);
            viewBody.innerHTML = '';

            if (tab === 'profile') {
                viewBody.innerHTML = `
                    <div class="col-12">
                        <div class="card bg-dark border-secondary p-4 text-center">
                            <i class="fas fa-user-circle fa-5x mb-3 text-primary"></i>
                            <h3>Botshabelo User</h3>
                            <p class="text-muted">Postal Code: 9781 | Free State</p>
                            <button class="btn btn-outline-primary w-100 mt-3">Edit Profile</button>
                            <button class="btn btn-outline-danger w-100 mt-2">Log Out</button>
                        </div>
                    </div>`;
                return;
            }

            const filtered = appData.filter(i => {
                if (tab === 'posts') return i.type === 'post' || i.type === 'street_view';
                if (tab === 'events') return i.type === 'event';
                if (tab === 'updates') return i.type === 'alert';
                return false;
            });

            if (filtered.length === 0) {
                viewBody.innerHTML = `<div class="col-12 text-center text-muted py-5">No ${tab} found in Botshabelo 9781.</div>`;
            } else {
                filtered.forEach(i => {
                    const col = document.createElement('div');
                    col.className = 'col-12 col-md-6';
                    col.innerHTML = `
                        <div class="card bg-dark border-secondary h-100 ${i.type === 'alert' ? 'border-danger' : ''}">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${i.title}</h5>
                                <p class="card-text">${i.content}</p>
                                ${i.media_url ? `<video class="w-100 rounded mb-2" autoplay loop muted><source src="${i.media_url}"></video>` : ''}
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <span class="badge bg-secondary">${i.type}</span>
                                    <small class="text-muted">${new Date(i.timestamp).toLocaleDateString()}</small>
                                </div>
                            </div>
                        </div>`;
                    viewBody.appendChild(col);
                });
            }
        }

        // --- 4. STREET VIEW UPLOAD LOGIC ---
        function openContributionMenu() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.capture = 'environment';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const fd = new FormData();
                fd.append('file', file);

                try {
                    const cdnRes = await fetch("https://cdn.oxeansa.co.za/upload", { method: 'POST', body: fd });
                    const cdnData = await cdnRes.json();

                    if (cdnData.url) {
                        navigator.geolocation.getCurrentPosition(async (pos) => {
                            await fetch(`${API_BASE}/posts`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    title: "Street View Video",
                                    content: "New community upload via 3D view",
                                    lon: pos.coords.longitude,
                                    lat: pos.coords.latitude,
                                    media_url: cdnData.url,
                                    type: 'street_view'
                                })
                            });
                            loadPins();
                            alert("3D Contribution live!");
                        });
                    }
                } catch (err) { alert("Upload failed"); }
            };
            input.click();
        }

        // --- 5. INITIALIZE ---
        loadPins();
        
        // Safety Proximity Monitor
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                const alertEl = document.getElementById('safety-toast');
                const danger = appData.find(item => {
                    if (item.type !== 'alert') return false;
                    const d = calculateDist(pos.coords.longitude, pos.coords.latitude, item.lon, item.lat) * 1000;
                    return d <= (item.radius || 300);
                });
                alertEl.style.display = danger ? 'block' : 'none';
            });
        }

        function calculateDist(lon1, lat1, lon2, lat2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
